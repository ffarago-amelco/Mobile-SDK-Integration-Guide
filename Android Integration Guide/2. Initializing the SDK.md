# Initializing the Android SDK

Perform the following steps to prepare the Android SDK for use.

## 1. Add Java 8
Add the following to the app module's `build.gradle` file, under the `android` object.

```groovy
compileOptions {
    sourceCompatibility JavaVersion.VERSION_1_8
    targetCompatibility JavaVersion.VERSION_1_8
}
```

## 2. Confgiure Kotlin (Only Required for Kotlin Support)
This SDK is completely interoperable with Java apps written in Kotlin, once the following setting is added to the app module's `build.gradle` file, under the `android` object:

```groovy
kotlinOptions {
    jvmTarget = '1.8'
}
```

>If you receive an error, such as `:app:transformClassesWithDesugarForDebug`, you may have to enable desugaring in your `gradle.properties` file, as follows:
  ```groovy
  android.enableD8.desugaring = true
  ```

## 3. Add Optimove's Android SDK Repository to Your Project
Update the dependency statement in your app module's `build.gradle` file, under the `dependencies` object, as follows:
  ```groovy
  implementation 'com.optimove.sdk:optimove-sdk:2.+'
  ```

>**Important Note**: Optimove uses [semantic versioning](https://semver.org/), which means that each time you `Sync Now` your `build.gradle`, Optimove's SDK will automatically get updated with any minor features, improvements and hotfixes.


## 4. Add the SDK to Your `BuildConfig`
Optimove's Product Integration team will provide you with the following details, which you need to add to your SDK initialization, as shown below:<br>
- ***YOUR_OPTIMOVE_TENANT_TOKEN*** – Your unique SDK token
- ***YOUR_OPTIMOVE_CONFIG_NAME*** – The mobile config used to store your app events. If you are using "staging" and "release" versions, refer to the following two examples:<br/>

**Staging**
```groovy
android {
    buildTypes {
        stg {
   	    //Note: Don't delete the quotation marks - only replace the <value> itself
	    buildConfigField "String", "OPTIMOVE_TENANT_TOKEN", "<YOUR_OPTIMOVE_TENANT_TOKEN>"
	    buildConfigField "String", "OPTIMOVE_CONFIG_NAME", "<YOUR_OPTIMOVE_CONFIG_NAME>-stg"

	    //Optional: Set to "true" during integration
	    buildConfigField "Boolean", "OPTIMOVE_CLIENT_STG_ENV", "true"
	    //Optional: Set to "debug" during integration
	    buildConfigField "String", "OPTIMOVE_MIN_LOG_LEVEL", "debug"
	    }
    }
}
```

**Release**
```groovy
android {
    buildTypes {
        release {
   	    //Note: Don't delete the quotation marks - only replace the <value> itself
	    buildConfigField "String", "OPTIMOVE_TENANT_TOKEN", "<YOUR_OPTIMOVE_TENANT_TOKEN>"
	    buildConfigField "String", "OPTIMOVE_CONFIG_NAME", "<YOUR_OPTIMOVE_CONFIG_NAME>"
	    buildConfigField "String", "OPTIMOVE_MIN_LOG_LEVEL", "error"
	    }
    }
}
```


## 5. Confgiure Manual Firebase Initialization (Optional)
This step is required _only_ if your app uses Firebase and does _not_ use the Google Play Services plugin to _automatically_ initialize the app.
    
First, disable Optimove's automatic initialization by setting this value to "true":
```groovy
buildConfigField "Boolean", "OPTIMOVE_DISABLE_AUTO_INIT", 'true'
```

Sample `buildConfig` code snippet:
**Release**
```groovy
android {
  buildTypes {
    release {
      buildConfigField "String", "OPTIMOVE_TENANT_TOKEN", "<YOUR_OPTIMOVE_TENANT_TOKEN>"
      buildConfigField "String", "OPTIMOVE_CONFIG_NAME", "<YOUR_OPTIMOVE_CONFIG_NAME>"
      buildConfigField "String", "OPTIMOVE_MIN_LOG_LEVEL", "error"
      // IMPORTANT - Set this to true only if you manually initialize the Firebase SDK
      buildConfigField "Boolean", "OPTIMOVE_DISABLE_AUTO_INIT", "true"
	  }
  }
}
```
    
Then, manually initialize the Optimove SDK  **after**  it initializes the default `FirebaseApp`, by using the following code snippet:

```java
// Implement this class only if you manually initialize the Firebase SDK (if you don't use the google-service.json file)
public class ManualFirebaseInitApplication extends Application {
  @Override
  public void onCreate() {
    super.onCreate();
    // It's crucial that you maintain the following order:
    // First, initialize the Firebase SDK
    FirebaseApp.initializeApp(this);
    // Then, initialize the Optimove SDK
    Optimove.configure(this, new TenantInfo("<YOUR_OPTIMOVE_TENANT_TOKEN>", "<YOUR_OPTIMOVE_CONFIG_NAME>"));
  }
}
```

## 6. Add FirebaseMessagingService
Do this step _only_ if you have FirebaseMessagingService already implemented in your app or in another Push provider's SDK.

When the hosting app also utilizes Firebase Cloud Messaging and implements the `FirebaseMessagingService` (either explicitly or implicitly through another third-party SDK), Android's Service Priority kicks in, and the Optimove SDK's own `FirebaseMessagingService` is never called. For this reason, the hosting app _must_ explicitly call Optimove's `onMessageReceived` and `onTokenRefresh` callbacks. 

The `OptipushMessagingHandler::onMessageReceived` method returns `true` if the push message was intended for the Optimove SDK.

```java
public class MyMessagingService extends FirebaseMessagingService {

    @Override
    public void onMessageReceived(RemoteMessage remoteMessage) {
      super.onMessageReceived(remoteMessage);
      boolean wasOptipushMessage = new OptipushMessagingHandler(this).onMessageReceived(remoteMessage);
      if (wasOptipushMessage) {
        // You should not attempt to present a notification at this point
        return;
      }
      // The notification was meant for the app, so perform your push logic/forward the remote message to other SDKs here
    }
    
    @Override
    public void onNewToken(String token) {
      super.onNewToken(token);
      // Forward the call to the Optimove SDK
      new OptipushFcmTokenHandler().onTokenRefresh();
      // Continue with the application logic/forward the token to other SDKs
    }
}
```

## 7. Defining SDK State
The Optimove SDK initialization process occurs asynchronously, off the `Main UI Thread`.<br>

Before calling the Public API methods, make sure that the SDK has finished initialization by calling the `registerSuccessStateListener` function within the the `OptimoveSuccessStateListener` instance.

```java
public class MainActivity extends AppCompatActivity implements OptimoveSuccessStateListener {

    /**  Important Note:
    If the object implementing the OptimoveSuccessStateListener is a component with a
    "Lifecycle" (i.e., Activity or Fragment), always unregister that object at the
    onStop() callback, to prevent memory leaks.
    **/

  @Override
  protected void onStart() {
    super.onStart();
    Optimove.registerSuccessStateListener(this);
  }

  @Override
  protected void onStop() {
    super.onStop();
    Optimove.unregisterSuccessStateListener(this);
  }

  //If required, ask for permissions at this stage. See Permissions, below.
  @Override
  public void onConfigurationSucceed(SdkRequiredPermission... missingPermissions) {
    // You may now start calling Optimove SDK functions (e.g., screenVisits)
  }
}
```

## 8. Permissions
Once the Optimove Android SDK has been successfully initialized, it passes all **missing user-dependent permissions** through `onConfigurationSucceed(SdkRequiredPermission... missingPermissions)`. These permissions are important to the _user experience_, but do not block the SDK's proper operation.

These permissions are:
- `DRAW_NOTIFICATION_OVERLAY` - Indicates that the app is not allowed to display a "drop down" notification banner when a new notification arrives
- `NOTIFICATIONS` - Indicates that the user has opted out from the app's notifications
- `GOOGLE_PLAY_SERVICES` - Indicates that the `Google Play Services` app on the user's device is missing or outdated
- `ADVERTISING_ID` - Indicates that the user has opted out from allowing apps to access his/her **Advertising ID**

## 9. Automatic Backup
Android SDK versions 23 and later offer the [Auto Backup for Apps](https://developer.android.com/guide/topics/data/autobackup) feature, which automatically backs up the user's app data, by uploading it to the user's Google Drive. This is used to prevent a corrupted state, when the user ID from a previous installations can leak into a new one.

The Optimove SDK depends on various local files being deleted once the app is uninstalled. For this reason, if the hosting app also defines `android:fullBackupContent="@xml/app_backup_rules"` in the manifest.xml file, Android will raise a merge conflict.

Follow these steps to resolve this conflict and maintain data integrity of the Optimove SDK:

- Add `tools:replace="android:fullBackupContent">` to the application tag.
- Copy the contents of the `optimove_backup_rules.xml` file to your full-backup-content xml.

## 10. Troubleshooting
If the `build.gradle` file shows the error, "All com.android.support libraries must use the exact same version specification (mixing versions can lead to runtime crashes). Found versions 28.0.0, <X.X.X>.", you need to add an explicit dependency to your `build.gradle` file that forces Gradle to resolve the conflict in the V4 support library:  `implementation 'com.android.support:support-v4:28.0.0'`
